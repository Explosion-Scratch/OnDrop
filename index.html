<link rel="manifest" href="manifest.json">
<link rel="favicon" href="https://ondrop.explosionscratc.repl.co/images/OnDrop-48.png">
<meta name="theme-color" content="#0d0e14">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Primary Meta Tags -->
<title>OnDrop</title>
<meta name="title" content="OnDrop">
<meta name="description" content="A lightning fast, simple online alternative to airdrop!">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://ondrop.explosionscratc.repl.co">
<meta property="og:title" content="OnDrop">
<meta property="og:description" content="A lightning fast, simple online alternative to airdrop!">
<meta property="og:image" content="images/OnDrop-512.png">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://ondrop.explosionscratc.repl.co">
<meta property="twitter:title" content="OnDrop">
<meta property="twitter:description" content="A lightning fast, simple online alternative to airdrop!">
<meta property="twitter:image" content="images/OnDrop-512.png">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

<script src="https://unpkg.com/socket.io-client@4.1.2/dist/socket.io.min.js"></script>

<script src="https://cdn.jsdelivr.net/gh/explosion-scratch/popup@v1.0.2/popup.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/explosion-scratch/popup@v1.0.2/popup.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.7/tailwind.min.css"/>
<script src="https://unpkg.com/vue@3"></script>

<script src="https://gitcdn.link/repo/polonel/SnackBar/master/dist/snackbar.min.js"></script>
<link rel="stylesheet" href="https://gitcdn.link/repo/polonel/SnackBar/master/dist/snackbar.min.css">

<div id="app">
	<transition name="scaleY" mode="out-in">
		<div v-if="!clients.length" class="text-center">
			<transition name="scaleY" mode="out-in">
				<h2 id="no_clients" class="italic font-extralight" :key="message">
						{{message}}
				</h2>
			</transition>
		</div>
	</transition>
	<transition name="fade" mode="out-in">
		<h2 v-if="clients.length" id="title">Drag a file to a device to upload it</h2>
	</transition>
	<transition name="fade" mode="out-in">
		<div id="container" v-if="clients.length" >
			<transition name="scale" mode="out-in">
				<span v-for="client in clients" :key="client.id" :data-id="client.id" class="capitalize" @click="upload_to_client($event)">
					{{client.name}}
				</span>
			</transition>
		</div>
	</transition>
</div>
<input id="fileInput" type="file" onchange="fileInputChange(this)" style="visibility:hidden;display:none;" />
<style>
	.fade-enter-active,
	.fade-leave-active {
		transition: opacity 1s ease;
	}

	.fade-enter-from,
	.fade-leave-to {
		opacity: 0;
	}
	.scale-enter-active,
.scale-leave-active {
  transform-origin: top;
  transition: transform 0.3s ease-in-out;
}

.scale-enter-to,
.scale-leave-from {
  transform: scaleX(1);
}

.scale-enter-from,
.scale-leave-to {
  transform: scaleX(0);
}


.scaleY-enter-active,
.scaleY-leave-active {
  transform-origin: top;
  transition: transform 0.3s ease-in-out;
}

.scaleY-enter-to,
.scaleY-leave-from {
  transform: scaleY(1);
}

.scaleY-enter-from,
.scaleY-leave-to {
  transform: scaleY(0);
}
</style>
<script>
	if (!navigator.onLine){
		offline();
	}
	window.addEventListener('online', online);
	window.addEventListener('offline', offline);

	const opts = {
		pos: "bottom-right",
		textColor: "#ccc",
		actionTextColor: "#383e61",
		backgroundColor: "#0d0e14",
		actionText: "Ok!",
	}
	function uploadNotice(){
		Snackbar.show({text: "Sent your file!", ...opts});
	}
	function offline(){
		Snackbar.show({text: "You're currently offline. Most functions of this app will not work.", ...opts});
	}
	function online(){
		Snackbar.show({text: "Back online again!", ...opts});
	}
</script>
<script>
	if('serviceWorker' in navigator){
		navigator.serviceWorker.register('sw.js')
			.then(reg => console.log('Service worker registered'))
			.catch(err => console.log('Service worker not registered', err));
	}
	var app = Vue.createApp({
		data(){
			return {
				clients: [],
				messages: ["Devices nearby or on the same network as you will show up here.", "Click on a device to open the file chooser", "Set ?ip=anything in the url to connect with someone far away", "The file size limit is 200mb."],
				messageIndex: 0,
			}
		},
		methods: {
			upload_to_client(event){
				var t = event.target;
				app.justClicked = t.getAttribute("data-id")
				var fileInput = document.querySelector("#fileInput");
				fileInput.click();
			}
		},
		computed: {
			message(){
				return this.messages[this.messageIndex];
			}
		},
		watch: {
			clients(){
				setTimeout(() => {
					console.log("clients updated")
					for (let el of document.querySelectorAll("[data-id]:not([drag-initiated])")){
						addDrag(el);
					}
				}, 500)
			}
		}
	}).mount("#app");

	setInterval(() => {
		app.messageIndex++;
		if (app.messageIndex > app.messages.length - 1){
			app.messageIndex = 0;
		}
	}, 5000)

	function fileInputChange(el){
		[...document.querySelectorAll("[data-id]")].find(i => i.getAttribute("data-id") === app.justClicked).setAttribute("uploading", "")
		var file = el.files[0];
		console.log("File input changed: ", file)
		socket.emit("uploading", {id})
		socket.emit("file", {file: file, name: file.name, type: file.type, to: app.justClicked})
	}

	document.onpaste = function (event) {
    var items = (event.clipboardData || event.originalEvent.clipboardData).items;
    console.log(JSON.stringify(items)); // might give you mime types
    for (var index in items) {
        var item = items[index];
				var file = item;
        if (item.kind === 'file') {
            file = item.getAsFile();
        } else if (item.kind === "string") {
					file = new File([file], "message.txt", {type: "text/plain"})
				} else { return }
				for (let item of document.querySelectorAll("[data-id]")){
					var id = item.getAttribute("data-id");
					item.setAttribute("uploading", "");
					socket.emit("uploading", {id});
					socket.emit("file", {
						file,
						name: file.name,
						type: file.type,
						to: id
					})
				}
    }
};


	function addDrag(dropZone){
		dropZone.setAttribute("drag-initiated", "")
		// Optional.   Show the copy icon when dragging over.  Seems to only work for chrome.
		dropZone.addEventListener('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
				dropZone.setAttribute("dragging", "");
				e.dataTransfer.dropEffect = 'copy';
		});

		// Get file data on drop
		dropZone.addEventListener('drop', async function(e) {
				dropZone.setAttribute("uploading", "")
				dropZone.removeAttribute("dragging");
				e.stopPropagation();
				e.preventDefault();
				var file = e.dataTransfer.files[0];
				if (!file){
					file = e.dataTransfer.items[0];
					console.log(file);
					file = file.getAsFile() || await new Promise(res => file.getAsString(res))
					if (typeof file === "string") {
						file = new File([file], "message.txt", {type: "text/plain"})
					}
					console.log(file)
					if (!file) return;
					file.name = "file"
				}
				socket.emit("uploading", {id})
				socket.emit("file", {file: file, name: file.name, type: file.type, to: dropZone.getAttribute("data-id")})
		});

		dropZone.addEventListener("dragleave", () => {
			dropZone.removeAttribute("dragging");
		})
	}

  var socket = io();
	var ip;
	var id = null;

	fetch("https://icanhazip.com/").then(res => res.text()).then(async (data) => {
			ip = data;
			if (!localStorage.getItem("name")){
				localStorage.setItem("name", await prompt({title: "Name", text: "Enter your name below."}))
			}
			socket.emit("ip", {name: localStorage.getItem("name"), addr: param("ip") || ip, userAgent: navigator.userAgent});
			ready();
	})
	
	function ready(){
		// var blob = new Blob(["test"], {type: "text/plain"});
		// TODO: Add person for destination
		// socket.emit("file", {file: blob, type: blob.type})
	}
	socket.on("joined room", (_) => console.log("Joined room: ", _))	
	socket.on("new client", (_) => {
		console.log("New client: ", _);
		app.clients = [...app.clients, _]
	})
	socket.on("client left", (_) => {
		console.log("Client left: ", _);
		app.clients = app.clients.filter(i => i.id !== _.id)
	})
	socket.on("test message", (_) => console.log("Got test message: ", _))
	socket.on("id", (_) => {
		console.log("This client's id is: ", _);
		id = _;
	})
	socket.on("uploading", ({id: _id}) => {
		console.log(_id);
		[...document.querySelectorAll("[data-id]")].find(i => i.getAttribute("data-id") === _id).setAttribute("uploading", "")
	})
	socket.on("done uploading", ({id: _id}) => {
		console.log(_id);
		[...document.querySelectorAll("[data-id]")].find(i => i.getAttribute("data-id") === _id).removeAttribute("uploading")
	})
	socket.on("got file", (info) => {
		console.log("info.fromId is: ", info.fromId, info.fromId === id)
		if (info.fromId === id){
			// This is to get file events from self, this means we can sense when the upload is done. We want to stop flashing the square.
			uploadNotice();
			[...document.querySelectorAll("[data-id]")].find(i => i.getAttribute("data-id") === info.to).removeAttribute("uploading")
			return;
		}
		if (info.to !== id) return;
		alert({title: `${info.from} sent you a file:`, backgroundclick: true, text: `<a href=${JSON.stringify(info.url)} class="underline">${info.name}</a><br><a id="download_link" href=${JSON.stringify(info.url)} download=${JSON.stringify(info.name)}>Download</a>`, buttontext: `Download`})

		document.getElementById("download_link").addEventListener("click", removePopup);
		document.getElementById("popup-bg").addEventListener("click", removePopup)
		document.getElementById("popup-close").remove();
		console.log("Got file", info, info.to === id)
		function removePopup(){
			[...document.querySelectorAll("#popup, #popup-bg")].forEach(i => i.remove())
		}
	});
	function param(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
</script>
<style>
* {
    font-family: "Montserrat", sans-serif;
}
#download_link {
    color: #bdc2e4;
    width: 94%;
    margin: 10px auto;
    display: block;
    padding: 15px;
    text-align: center;
    border-radius: 10px;
    transition: opacity .3s ease;
    background: #0d0e14;
box-shadow:  5px 5px 10px #060609,
             -5px -5px 10px #14161f;
}
#download_link:active {
    background: #0d0e14;
box-shadow: inset 5px 5px 10px #060609,
            inset -5px -5px 10px #14161f;
}

#popup {
    background: #0d0e14;
    box-shadow: 0px 0px 10px #191b27;
    color: white;
    width: 70vw;
    max-width: 500px;
}
#popup button {
    background: #191b27;
    border: none;
}
#popup-bg {
    filter: none !important;
    backdrop-filter: blur(3px);
}
#popup button:hover {
    background: #191b27;
}
#popup-title {
    font-weight: 600;
    text-align: center;
    font-size: 1.1rem;
}
#popup input {
    background: #0d0e14;
    border-color: #222;
    margin-top: 10px;
    margin-bottom: 10px;
}
#popup input:focus {
    box-shadow: 0 0 5px 2px #191b27;
}
#popup button:not(:disabled):hover {
    background: #222536;
}

body {
    text-align: center;
    background: #0d0e14;
    width: 100vw;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #b0b8ca;
}

[data-id]{
    margin: 20px;
    font-weight: 300;
    cursor: pointer;
    text-align: center;
    height: 120px;
    width: 120px;
    padding: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 20%;
    background: #0d0e14;
box-shadow:  20px 20px 60px #060609,
             -20px -20px 60px #14161f;
    color: #ccc;
}
#title {
    position: absolute;
    font-style: italic;
    bottom: 20px;
    left: 50%;
    transform: translate(-50%);
}
#container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 50vw;
}
[data-id]:hover{
    background: linear-gradient(145deg, #0c0d12, #0e0f15);
		box-shadow:  20px 20px 60px #060609,
             -20px -20px 60px #14161f;
}
/* dragging */
[data-id][dragging] {
    background: linear-gradient(145deg, #0f1018, #0d0e14);
box-shadow:  20px 20px 60px #060609,
             -20px -20px 60px #161823;
    animation: wiggle 1s infinite linear;
}
[data-id][uploading] {
    border: 2px solid #404566;
    animation: border 1s infinite linear;
}
@keyframes border {
    0% {
        border-color: #0000;
    }
    50% {
        border-color: #404566
    }
    100% {
        border-color: #0000;
    }
}
@keyframes wiggle {
    10% {
        transform: rotate(10deg);
    }
    20% {
        transform: rotate(-10deg)
    }
    30% {
        transform: rotate(10deg);
    }
    40% {
        transform: rotate(-10deg)
    }
    50% {
        transform: rotate(10deg);
    }
    60% {
        transform: rotate(-10deg)
    }
    70% {
        transform: rotate(10deg);
    }
    80% {
        transform: rotate(-10deg)
    }
    90% {
        transform: rotate(10deg);
    }
    100% {
        transform: rotate(-10deg)
    }
}
</style>